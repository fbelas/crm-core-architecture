<%# Para lidar-mos com a quantidade de dados %>
<%# foi necessario construir o objecto para preencher as linhas da tabela %>
<%# que depois passa para o stimulus %>
<%
result = []
@professionals_search_results&.each do |elem|

    affiliations_list = elem.affiliations.map { |affiliation| "<i class='fa-solid fa-house-chimney'></i> #{affiliation}" }.join("<br>")

    @present = @professionals_from_department_ids&.include?(elem.customer_id)
    form_obj =  if @present
                        render partial: "prof_dept_affiliations/affiliation_already_created"
                else
                    simple_form_for @new_prof_dept_affiliation, url: create_through_institution_path(institution_id: @institution_id), html: { id: "new_onepharma_prof_dept_affiliation_#{elem.customer_id}" } do |f|
                        concat f.hidden_field :FROM_CUSTOMER_ID, value: elem.customer_id
                        concat f.hidden_field :TO_CUSTOMER_ID, value: @department.id
                        concat f.hidden_field :STATUS, value: "ACTV"

                        concat(content_tag(:div, style: 'width:100%;') do
                            f.input :AFFILIATION_ROLE_1, as: :select,
                                        collection: @affiliation_roles_list_for_select,
                                        placeholder: 'email@example.com',
                                        label: false,
                                        input_html: {
                                            data: {
                                                controller: 'select2',
                                                select2_placeholder_value: I18n.t('placeholder.select2_role')
                                            }
                                        }
                        end)
                        concat(content_tag(:div, class: "row") do
                            concat(content_tag(:div, class: "col-8") do
=begin
                                f.input :COMPANY_DB_OWNER, as: :select,
                                            collection: @affiliation_owners_list_for_select,
                                            label: false,
                                            input_html: {
                                                data: {
                                                    controller: "select2",
                                                    select2_placeholder_value: I18n.t("placeholder.select2_database")
                                                }
                                            }
=end
                            end)
                            concat(content_tag(:div, class: "col-4") do
                                f.submit class: 'btn btn-dark_green', value: 'Adicionar'
                            end)
                        end)
                    end
                end

    result << [
            elem.customer_id,
            elem.external_id_1,
            elem.full_name,
            elem.specialties,
            affiliations_list,
            form_obj
   ]
end
%>


<%= turbo_stream.replace 'flash_notification', partial: "shared/flash_notification" %>
<%#= turbo_stream.replace 'professional_searched_table', partial: "prof_dept_affiliations/modals/institution_add_new_prof_dept_affiliation_table" %>
<%= turbo_stream.append 'professional_searched_table' do %>
    <script>
        (function(){
            let html_obj = document.getElementById("professional_searched_table");
            html_obj.dispatchEvent(new CustomEvent('ReloadNewData', {detail: <%= raw result.to_json %>}));
        })()
    </script>
<% end  %>
